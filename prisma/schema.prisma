generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Departement {
  id            Int           @id @default(autoincrement())
  nom           String        @unique
  responsableId Int?
  responsable   Utilisateur?  @relation("DepartementResponsable", fields: [responsableId], references: [id])
  tickets       Ticket[]
  employes      Utilisateur[]
}

model Utilisateur {
  id                       Int            @id @default(autoincrement())
  nom                      String
  prenom                   String
  email                    String         @unique
  motDePasse               String
  role                     Role           @default(EMPLOYE)
  matricule                String?        @unique
  departementId            Int?
  createdAt                DateTime       @default(now())
  /// Code hiérarchique : 0 = employé simple, 1+ = niveaux de supervision
  /// Plus le code est élevé, plus le niveau hiérarchique est haut
  codeHierarchique         Int            @default(0)
  commentairesRediges      Commentaire[]  @relation("CommentaireAuteur")
  departementsResponsables Departement[]  @relation("DepartementResponsable")
  notifications            Notification[]
  ticketsAssignes          Ticket[]       @relation("TechnicienTickets")
  tickets                  Ticket[]       @relation("EmployeTickets")
  departement              Departement?   @relation(fields: [departementId], references: [id])

  @@index([departementId, codeHierarchique])
}

model Application {
  id      Int      @id @default(autoincrement())
  nom     String   @unique
  tickets Ticket[]
}

model Materiel {
  id      Int      @id @default(autoincrement())
  nom     String   @unique
  tickets Ticket[]
}

model Ticket {
  id                     Int            @id @default(autoincrement())
  description            String
  dateCreation           DateTime       @default(now())
  statut                 Statut?        @default(OPEN)
  type                   TypeTicket
  createdById            Int
  assignedToId           Int?
  departementId          Int?
  mailSentAt             DateTime?
  applicationId          Int?
  clotureAt              DateTime?
  dureeTraitementMinutes Int?
  mantisAt              DateTime?
  mantisNumero          String?
  materielId             Int?
  prisEnChargeAt         DateTime?
  commentaires           Commentaire[]
  notifications          Notification[]
  piecesJointes          PieceJointe[]
  application            Application?   @relation(fields: [applicationId], references: [id])
  assignedTo             Utilisateur?   @relation("TechnicienTickets", fields: [assignedToId], references: [id])
  createdBy              Utilisateur    @relation("EmployeTickets", fields: [createdById], references: [id])
  departement            Departement?   @relation(fields: [departementId], references: [id])
  materiel               Materiel?      @relation(fields: [materielId], references: [id])
}

model Commentaire {
  id        Int         @id @default(autoincrement())
  contenu   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  ticketId  Int
  auteurId  Int
  auteur    Utilisateur @relation("CommentaireAuteur", fields: [auteurId], references: [id])
  ticket    Ticket      @relation(fields: [ticketId], references: [id])

  @@index([ticketId, createdAt])
}

model Notification {
  id        Int         @id @default(autoincrement())
  message   String
  dateEnvoi DateTime    @default(now())
  ticketId  Int
  isRead    Boolean     @default(false)
  userId    Int
  ticket    Ticket      @relation(fields: [ticketId], references: [id])
  user      Utilisateur @relation(fields: [userId], references: [id])
}

model PieceJointe {
  id         Int      @id @default(autoincrement())
  nomFichier String
  chemin     String
  dateAjout  DateTime @default(now())
  ticketId   Int
  ticket     Ticket   @relation(fields: [ticketId], references: [id])
}

enum Role {
  EMPLOYE
  TECHNICIEN
  CHEF_DSI
}

enum Statut {
  OPEN
  IN_PROGRESS
  CLOSED
  A_CLOTURER
  REJETE
  TRANSFERE_MANTIS
}

enum TypeTicket {
  ASSISTANCE
  INTERVENTION
}
